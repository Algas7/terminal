parameters:
  configuration: 'Fuzzing'
  platform: ''
  additionalBuildArguments: ''

jobs:
- job: Build${{ parameters.platform }}${{ parameters.configuration }}
  displayName: Build ${{ parameters.platform }} ${{ parameters.configuration }}
  variables:
    BuildConfiguration: ${{ parameters.configuration }}
    BuildPlatform: ${{ parameters.platform }}
  pool: 
    ${{ if eq(variables['System.CollectionUri'], 'https://dev.azure.com/ms/') }}:
      name: WinDevPoolOSS-L
    ${{ if ne(variables['System.CollectionUri'], 'https://dev.azure.com/ms/') }}:
      name: WinDevPool-L
    demands: ImageOverride -equals WinDevVS16-latest

  steps:
  - task: PowerShell@2
    displayName: 'Rationalize build platform'
    inputs:
      targetType: inline
      script: |
        $Arch = "$(BuildPlatform)"
        If ($Arch -Eq "x86") { $Arch = "Win32" }
        Write-Host "##vso[task.setvariable variable=RationalizedBuildPlatform]${Arch}"

  - task: CopyFiles@2
    displayName: 'Copy result logs to Artifacts'
    inputs:
      Contents: |
       **/*.wtl
       **/*onBuildMachineResults.xml
       ${{ parameters.testLogPath }}
      TargetFolder: '$(Build.ArtifactStagingDirectory)/$(BuildConfiguration)/$(BuildPlatform)/test'
      OverWrite: true
      flattenFolders: true

  - task: CopyFiles@2
    displayName: 'Copy *.appx/*.msix to Artifacts (Non-PR builds only)'
    inputs:
      Contents: |
       **/*.appx
       **/*.msix
       **/*.appxsym
       !**/Microsoft.VCLibs*.appx
      TargetFolder: '$(Build.ArtifactStagingDirectory)/appx'
      OverWrite: true
      flattenFolders: true
    condition: succeeded()

  - task: CopyFiles@2
    displayName: 'Copy outputs needed for test runs to Artifacts'
    inputs:
      Contents: |
       $(Build.SourcesDirectory)/bin/$(RationalizedBuildPlatform)/$(BuildConfiguration)/*.exe
       $(Build.SourcesDirectory)/bin/$(RationalizedBuildPlatform)/$(BuildConfiguration)/*.dll
       $(Build.SourcesDirectory)/bin/$(RationalizedBuildPlatform)/$(BuildConfiguration)/*.xml
       **/Microsoft.VCLibs.*.appx
       **/TestHostApp/*.exe
       **/TestHostApp/*.dll
       **/TestHostApp/*.xml
       !**/*.pdb
       !**/*.ipdb
       !**/*.obj
       !**/*.pch
      TargetFolder: '$(Build.ArtifactStagingDirectory)/$(BuildConfiguration)/$(BuildPlatform)/test'
      OverWrite: true
      flattenFolders: true
    condition: succeeded()

  - task: PublishBuildArtifacts@1
    displayName: 'Publish All Build Artifacts'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'drop'